(()=>{class e{constructor(){this.modal=null,this.modalContent=null,this.currentProductId=null,this.currentAction=null,this.previouslyFocusedElement=null,void 0!==window.wcPreOrdersProductsList&&this.init()}init(){this.initInternationalization(),this.initModal(),this.initEventListeners()}initInternationalization(){const e=window.wcPreOrdersProductsList;this.i18n=e.i18n||{},this.ajax_url=e.ajax_url||"",this.nonce=e.nonce||"",this.currency_symbol=e.currency_symbol||"",this.currency_position=e.currency_position||"",this.datepickerTimezone=e.datepicker_timezone||0}initModal(){this.modal=document.getElementById("pre-orders-product-modal"),this.modal&&(this.modalContent=this.modal.querySelector(".wc-po-modal-content"),this.initializeDateTimePicker())}initEventListeners(){if(!this.modal)return;document.addEventListener("change",(e=>{e.target.matches(".pre-order-toggle")&&this.handleToggleChange(e)})),this.modal.addEventListener("click",(e=>{e.target.matches(".modal-close, #modal-cancel")&&this.closeModal()}));const e=document.getElementById("modal-confirm");e&&e.addEventListener("click",(()=>{this.handleModalConfirm()})),this.modal.addEventListener("click",(e=>{e.target===this.modal&&this.closeModal()})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&"none"!==this.modal.style.display&&this.closeModal()}))}initializeDateTimePicker(){const e=()=>{"undefined"!=typeof jQuery&&jQuery.fn.datetimepicker?jQuery("#pre-order-availability").datetimepicker({dateFormat:"yy-mm-dd",timeFormat:"HH:mm",numberOfMonths:1,timezone:this.datepickerTimezone||0}):setTimeout(e,100)};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e):e()}handleToggleChange(e){const t=e.target,o=t.dataset.productId,n="yes"===t.dataset.enabled;t.disabled?e.preventDefault():(this.currentProductId=o,this.currentAction=n?"disable":"enable",t.checked=n,this.setProductTitleInModal(o),n?this.showDisableConfirmation():this.getProductSettings(o))}setProductTitleInModal(e){const t=document.querySelector(`tr#post-${e} td.name.column-name.has-row-actions.column-primary a.row-title`),o=document.getElementById("modal-product-title");t&&o&&(o.textContent=t.textContent)}showDisableConfirmation(){this.updateModalContent({title:this.i18n.modal_title_disable,showAvailabilityField:!1,showFeeField:!1,showChargeField:!1,showBulkNote:!1,showEnableMessage:!1,showConfirmMessage:!0,confirmMessage:this.i18n.confirm_disable,confirmButton:this.i18n.disable_button||"Disable pre-orders for this product"}),this.adjustDisableConfirmationModalStyles(),this.openModal()}adjustDisableConfirmationModalStyles(){const e=document.querySelector(".woocommerce_options_panel");e&&(e.style.minHeight="auto");const t=document.getElementById("modal-product-title");t&&(t.style.marginBottom="0");const o=document.querySelector(".wc-po-modal-buttons");o&&(o.style.marginTop="10px");const n=document.querySelector(".woocommerce_options_panel p");n&&(n.style.marginTop="5px !important")}async getProductSettings(e){try{const t=new FormData;t.append("action","wc_pre_orders_get_product_settings"),t.append("product_id",e),t.append("security",this.nonce);const o=await fetch(this.ajax_url,{method:"POST",credentials:"same-origin",body:t});if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const n=await o.json();if(!n.success)throw new Error(n.data.message||this.i18n.error_generic);this.showEnableModal(n.data)}catch(e){this.showNotice(this.i18n.error_generic,"error")}}showEnableModal(e){this.updateModalContent({title:this.i18n.modal_title_enable,showAvailabilityField:!0,showFeeField:!0,showChargeField:!0,showBulkNote:!1,showEnableMessage:!0,showConfirmMessage:!1,confirmButton:this.i18n.enable_button||"Enable pre-orders for this product"}),this.setFormValues(e),this.openModal(),setTimeout((()=>{this.initializeDateTimePicker()}),100)}updateModalContent(e){if(document.getElementById("modal-title").textContent=e.title,this.toggleElement("availability-field",e.showAvailabilityField),this.toggleElement("fee-field",e.showFeeField),this.toggleElement("charge-field",e.showChargeField),this.toggleElement("bulk-note",e.showBulkNote),this.toggleElement("enable-message",e.showEnableMessage),this.toggleElement("confirm-message",e.showConfirmMessage),e.showConfirmMessage&&e.confirmMessage){const t=document.getElementById("confirm-message").querySelector("p");t&&(t.textContent=e.confirmMessage)}document.getElementById("modal-confirm").textContent=e.confirmButton}toggleElement(e,t){const o=document.getElementById(e);o&&(o.style.display=t?"block":"none")}setFormValues(e){const t=document.getElementById("pre-order-availability");if(t){const o=e.availability?e.availability.replace("T"," "):"";t.value=o}const o=document.getElementById("pre-order-fee");o&&(o.value=e.fee||"");const n=document.getElementById("pre-order-charge");n&&(n.value=e.when_to_charge||"upon_release")}openModal(){if(!this.modal)return;this.previouslyFocusedElement=this.modal.ownerDocument.activeElement,this.modal.style.display="block",document.body.classList.add("modal-open");const e=this.modal.querySelector("input, select, textarea");e&&setTimeout((()=>{e.focus()}),100)}closeModal(){this.modal&&(this.modal.style.display="none",document.body.classList.remove("modal-open"),this.currentProductId=null,this.currentAction=null,this.previouslyFocusedElement&&(this.previouslyFocusedElement.focus(),this.previouslyFocusedElement=null))}async handleModalConfirm(){const e=document.getElementById("modal-confirm"),t=e.textContent;e.disabled=!0,e.textContent=this.i18n.processing;try{const e=await this.submitToggleRequest();if(!e.success)throw new Error(e.data.message||this.i18n.error_generic);this.updateProductRow(this.currentProductId,"enable"===this.currentAction),this.closeModal(),this.showNotice(e.data.message,"success")}catch(e){this.showNotice(this.i18n.error_generic,"error")}finally{e.disabled=!1,e.textContent=t}}async submitToggleRequest(){const e=new FormData;e.append("action","wc_pre_orders_toggle_product"),e.append("product_id",this.currentProductId),e.append("enable","enable"===this.currentAction?"yes":"no"),e.append("security",this.nonce),"enable"===this.currentAction&&this.appendEnableSettings(e);const t=await fetch(this.ajax_url,{method:"POST",credentials:"same-origin",body:e});if(!t.ok)throw new Error(`HTTP error status: ${t.status}`);return await t.json()}appendEnableSettings(e){const t=document.getElementById("pre-order-availability").value,o=document.getElementById("pre-order-fee").value,n=document.getElementById("pre-order-charge"),i=n?n.value:"upon_release";if(t){const o=t.replace("T"," ");e.append("availability_date",o)}o&&e.append("fee",o),i&&e.append("when_to_charge",i)}updateProductRow(e,t){const o=document.querySelector(`tr#post-${e}`);if(!o)return;const n=o.querySelector("td.pre_order");if(!n)return;const i=n.querySelector(".pre-order-toggle");i&&(i.dataset.enabled=t?"yes":"no",i.checked=t)}showNotice(e,t){const o="success"===t?"notice-success":"notice-error",n=document.createElement("div");n.className=`notice ${o} is-dismissible`,n.innerHTML=`<p>${e}</p>`;const i=document.querySelector(".wp-header-end");i&&i.after(n),setTimeout((()=>{n.style.opacity="0",setTimeout((()=>n.remove()),300)}),5e3)}getCurrencyPrefix(){return"left"===this.currency_position||"left_space"===this.currency_position?`<span class="currency-symbol">${this.currency_symbol}</span>`:""}getCurrencySuffix(){return"right"===this.currency_position||"right_space"===this.currency_position?`<span class="currency-symbol">${this.currency_symbol}</span>`:""}}document.addEventListener("DOMContentLoaded",(()=>{new e}))})();